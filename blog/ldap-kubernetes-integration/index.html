<!DOCTYPE html>
<html lang="en-us"><head>
  <title>RahmatAwe</title>

<meta name="theme-color" content="" />
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<meta name="description" content="Living, Working, Sleeping" />
<meta name="author" content="Rahmat Agung Wibowo" />
<meta name="generator" content="aafu theme by Darshan in Hugo 0.74.3" />

        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">        <link rel="manifest" href="/site.webmanifest">        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">        <link rel="shortcut icon" href="/favicon.ico">        

  <link
    rel="stylesheet"
    href="/css/bootstrap/bootstrap.min.css"
  />
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
    integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"
  />
  <link
    rel="stylesheet"
    href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"
  />
  <link rel="stylesheet" href="/css/aafu_light.css" />
  <link rel="stylesheet" href="/css/aafu.css" />

  <script>
    var themeColor = document.querySelector("meta[name=theme-color]");
    window.onload = () => {
      themeColor.content = getComputedStyle(document.body)["background-color"];
      let defaultActivePanel = document.querySelector(".accordion.active");
      if (defaultActivePanel) {
        defaultActivePanel.nextElementSibling.style.maxHeight =
          defaultActivePanel.nextElementSibling.scrollHeight + "px";
      }
    };
    window.onresize = () => {
      let defaultActivePanel = document.querySelector(".accordion.active");
      if (defaultActivePanel) {
        defaultActivePanel.nextElementSibling.style.maxHeight =
          defaultActivePanel.nextElementSibling.scrollHeight + "px";
      }
    };
  </script>
</head>
<body class="container">
    <main style="min-height: calc(100vh - 60px);">
      
      <div class="d-flex flex-row row p-2">
  <h3 class="main-menu mr-3">
    <a href="https://riupie.github.io">Home</a>
  </h3>
  <h3 class="main-menu mr-3">
    <a href="/blog">Blog</a>
  </h3>
  <h3 class="main-menu mr-3">
    <a href="/categories">Categories</a>
  </h3>
</div>

      
<div class="rounded p-2 aafu-border border">
  <div class="border-bottom aafu-border">
    <h1 class="top-h1" style="font-size: 2.75em;">Implementing LDAP Authentication for Kubernetes using Dex on Ubuntu 18.04</h1><div class="mb-2">
  <p class="mb-1">November 6, 2020</p>
   
  
  <p class="metadata-value mb-1 taxa taxa-container-div list-categories">
    Categories: 
    <a
      class="pl-1 pr-1 rounded border border-secondary"
      href="/categories/devops"
      title="categories"
    >devops</a>
    
  </p>
  
  
  
  
  
  <p class="metadata-value mb-1 taxa taxa-container-div list-tags">
    Tags: 
    <a
      class="pl-1 pr-1 rounded border border-secondary"
      href="/tags/ldap"
      title="tags"
    >ldap</a>
    
    <a
      class="pl-1 pr-1 rounded border border-secondary"
      href="/tags/kubernetes"
      title="tags"
    >kubernetes</a>
    
    <a
      class="pl-1 pr-1 rounded border border-secondary"
      href="/tags/linux"
      title="tags"
    >linux</a>
    
  </p>
  
  
</div>
</div>
  <div class="content">
    <h2 id="environment">Environment</h2>
<pre><code># Servers
ag-k8s-master0 : 10.54.54.10/24  (Kubernetes Master)
ag-k8s-worker0 : 10.54.54.20/24  (Kubernetes Worker)
ag-k8s-worker1 : 10.54.54.21/24  (Kubernetes Worker)
ag-k8s-ldap    : 10.54.54.30/24  (LDAP Server, DNS Server)

# Packages Release
Ubuntu 18.04
Kubernetes 1.19
OpenLDAP 2.4
</code></pre><h2 id="part-1-pre-flight">Part 1: Pre-Flight</h2>
<h3 id="1-setup-dns-server">1. Setup DNS Server</h3>
<p>For simplicity, I used dnsmasq with minimal configuration. You can use your prefered DNS Server (ex: bind9).</p>
<h4 id="11-install-dnsmasq">1.1. Install DNSMASQ</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@ag-k8s-ldap:~# apt -y install dnsmasq
</code></pre></div><h4 id="12-configure-dnsmasq-uncomment-line-below">1.2. Configure Dnsmasq. Uncomment line below.</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@ag-k8s-ldap:~# vim /etc/dnsmasq.conf

domain-needed
bogus-priv
strict-order

root@ag-k8s-ldap:~# systemctl restart dnsmasq
</code></pre></div><h4 id="13-add-dns-records-on-etchosts">1.3. Add DNS Records on /etc/hosts.</h4>
<pre><code>10.54.54.10 dex.kubernetes.riupie.com kubectl.kubernetes.riupie.com dashboard.kubernetes.riupie.com
10.54.54.30 ldap.riupie.com
</code></pre><h4 id="14-add-dns-server-to-each-kubernetes-nodes">1.4. Add DNS Server to each Kubernetes nodes.</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ sudo vim /etc/netplan/50-cloud-init.yaml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">network</span>:
    <span style="color:#66d9ef">ethernets</span>:
        <span style="color:#66d9ef">ens3</span>:
            <span style="color:#66d9ef">addresses</span>:
            - <span style="color:#ae81ff">10.54.54.10</span>/<span style="color:#ae81ff">24</span>
            <span style="color:#66d9ef">gateway4</span>: <span style="color:#ae81ff">10.54.54.1</span>
            <span style="color:#66d9ef">nameservers</span>:
                <span style="color:#66d9ef">addresses</span>:
                - <span style="color:#ae81ff">10.54.54.30</span>
    <span style="color:#66d9ef">version</span>: <span style="color:#ae81ff">2</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ sudo netplan apply
</code></pre></div><h4 id="15-verify-dns-server">1.5. Verify DNS Server</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ nslookup ldap.riupie.com

Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
Name:	ldap.riupie.com
Address: 10.54.54.30
</code></pre></div><h3 id="2-setup-ldap-server">2. Setup LDAP Server</h3>
<h4 id="21-install-openldap">2.1. Install OpenLDAP</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@ag-k8s-ldap:~# apt -y install slapd ldap-utils -y

 +--------------------------| Configuring slapd |-------------------------+
 | Please enter the password <span style="color:#66d9ef">for</span> the admin entry in your LDAP directory.  |
 |                                                                        |
 | Administrator password:                                                |
 |                                                                        |
 | ********______________________________________________________________ |
 |                                                                        |
 |                                 &lt;Ok&gt;                                   |
 |                                                                        |
 +------------------------------------------------------------------------+
</code></pre></div><h4 id="22-configure-ldap-server">2.2. Configure LDAP Server</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@ag-k8s-ldap:~# dpkg-reconfigure slapd
</code></pre></div><h4 id="23-verify-configuration">2.3. Verify configuration</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@ag-k8s-ldap:~# slapcat

dn: dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Riupie
dc: riupie
structuralObjectClass: organization
entryUUID: d89b3fe8-8c51-103a-8b49-d95647de1143
creatorsName: cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
createTimestamp: 20200916101927Z
entryCSN: 20200916101927.851031Z#000000#000#000000
modifiersName: cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
modifyTimestamp: 20200916101927Z

dn: cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
userPassword:: e1NTSEF9UGM2NjNPT0M3MXhwMVMvRGZyVCszSFNBeEpzM1ZBdXA<span style="color:#f92672">=</span>
structuralObjectClass: organizationalRole
entryUUID: d89b72ba-8c51-103a-8b4a-d95647de1143
creatorsName: cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
createTimestamp: 20200916101927Z
entryCSN: 20200916101927.852372Z#000000#000#000000
modifiersName: cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
modifyTimestamp: 20200916101927Z
</code></pre></div><h4 id="24-add-initial-data-for-kubernetes-user">2.4. Add initial data for Kubernetes User</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-ldap:~$ vim k8s.ldif

dn: ou<span style="color:#f92672">=</span>People,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: organizationalUnit
ou: People

dn: cn<span style="color:#f92672">=</span>jane,ou<span style="color:#f92672">=</span>People,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: jane
mail: janedoe@riupie.com
uid: jane
userPassword: jane@123

dn: cn<span style="color:#f92672">=</span>john,ou<span style="color:#f92672">=</span>People,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: john
mail: johndoe@riupie.com
uid: john
userPassword: john@123

dn: ou<span style="color:#f92672">=</span>Groups,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: organizationalUnit
ou: Groups

dn: cn<span style="color:#f92672">=</span>admins,ou<span style="color:#f92672">=</span>Groups,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: groupOfNames
cn: admins
member: cn<span style="color:#f92672">=</span>john,ou<span style="color:#f92672">=</span>People,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com

dn: cn<span style="color:#f92672">=</span>developers,ou<span style="color:#f92672">=</span>Groups,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com
objectClass: groupOfNames
cn: developers
member: cn<span style="color:#f92672">=</span>jane,ou<span style="color:#f92672">=</span>People,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com

<span style="color:#75715e">#Insert into LDAP database</span>
ubuntu@ag-k8s-ldap:~$ ldapadd -cx -D cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>riupie,dc<span style="color:#f92672">=</span>com -W -f k8s.ldif
</code></pre></div><h2 id="part-2-bootstrapping-kubernetes-cluster">Part 2: Bootstrapping Kubernetes Cluster</h2>
<h3 id="3-deploy-kubernetes-cluster-run-as-regular-user">3. Deploy Kubernetes Cluster (run as regular user)</h3>
<h4 id="31-install-docker-on-all-kubernetes-nodes">3.1. Install Docker on all Kubernetes nodes</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get update
sudo apt install docker.io -y

sudo systemctl enable docker
sudo systemctl start docker
sudo systemctl status docker
</code></pre></div><h4 id="32-add-kubernetes-repository-on-all-kubernetes-nodes">3.2. Add kubernetes repository on all Kubernetes nodes</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add
sudo apt-add-repository <span style="color:#e6db74">&#34;deb http://apt.kubernetes.io/ kubernetes-xenial main&#34;</span>
</code></pre></div><h4 id="33-install-kubernetes-installation-tools-on-all-kubernetes-nodes">3.3. Install Kubernetes Installation Tools on all Kubernetes nodes</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install kubeadm kubelet kubectl -y
sudo apt-mark hold kubeadm kubelet kubectl
kubeadm version
</code></pre></div><h4 id="34-disable-swap-memory-on-all-kubernetes-nodes">3.4. Disable Swap Memory on all Kubernetes nodes</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo swapoff –a
</code></pre></div><h4 id="35-initialize-kubernetes-on-master-node">3.5. Initialize Kubernetes on Master Node</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ sudo kubeadm init --pod-network-cidr<span style="color:#f92672">=</span>192.168.0.0/16
</code></pre></div><h4 id="36-create-cluster-directory-on-master-node">3.6. Create cluster directory on Master Node</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ mkdir -p $HOME/.kube
ubuntu@ag-k8s-master0:~$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
ubuntu@ag-k8s-master0:~$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</code></pre></div><h4 id="37-install-calico-cni-from-master-node">3.7. Install Calico CNI from Master Node</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ curl https://docs.projectcalico.org/manifests/calico.yaml -O
ubuntu@ag-k8s-master0:~$ kubectl apply -f calico.yaml
</code></pre></div><h4 id="38-print-join-command-from-master-node">3.8. Print join command from Master Node</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ sudo kubeadm token create --print-join-command

kubeadm join 10.54.54.10:6443 --token 2a80cg.tatnw7n3jaqsio5c     --discovery-token-ca-cert-hash sha256:70c6d0e5c2c9d3bfab4797dc9177b61136e5e690035042b8bdac58776f55818a
</code></pre></div><h4 id="39-join-nodes-execute-on-each-worker-nodes">3.9. Join nodes. Execute on each worker nodes</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubeadm join 10.54.54.10:6443 --token ksgb87.m58b7ov99tc6p47p --discovery-token-ca-cert-hash sha256:70c6d0e5c2c9d3bfab4797dc9177b61136e5e690035042b8bdac58776f55818a
</code></pre></div><h4 id="310-verify-cluster">3.10. Verify cluster</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ kubectl get nodes
ubuntu@ag-k8s-master0:~$ kubectl cluster-info
</code></pre></div><h4 id="311-install-helm-3-from-master-node">3.11. Install Helm 3 from Master Node</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ sudo apt-get install apt-transport-https -y

ubuntu@ag-k8s-master0:~$ echo <span style="color:#e6db74">&#34;deb https://baltocdn.com/helm/stable/debian/ all main&#34;</span> | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list

ubuntu@ag-k8s-master0:~$ sudo apt-get update
ubuntu@ag-k8s-master0:~$ sudo apt-get install helm
</code></pre></div><h2 id="part-3-deploy-cert-manager">Part 3: Deploy Cert Manager</h2>
<h3 id="4-install-nginx-controller-community">4. Install NGINX Controller Community</h3>
<h4 id="41-add-nginx-controller-community-helm-repo">4.1. Add NGINX Controller Community helm repo</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
ubuntu@ag-k8s-master0:~$ helm install nginx-controller-community ingress-nginx/ingress-nginx
</code></pre></div><h4 id="42-expose-nginx-controller-as-externalips-only-needed-if-you-have-no-service-type-loadbalancer-support">4.2. Expose NGINX Controller as externalIPs (only needed if you have no Service Type LoadBalancer support)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ kubectl edit svc nginx-controller-community-ingress-nginx-controller

* add externalIP on thi section
...
  selector:
    app: ingress-nginx
  externalIPs:
  - IP-MASTER-NODE
...
</code></pre></div><h3 id="5-install-cert-manager">5. Install cert-manager</h3>
<h4 id="51-generate-self-signed-cert-for-kubernetesriupiecom-domain">5.1. Generate Self Signed cert for *.kubernetes.riupie.com domain</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ openssl req -newkey rsa:4096 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-x509 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-sha256 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-days <span style="color:#ae81ff">3650</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-nodes <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-out riupie.com.crt <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-keyout riupie.com.key

ubuntu@ag-k8s-master0:~$ mkdir .cert
ubuntu@ag-k8s-master0:~$ mv riupie.com.* .cert

<span style="color:#75715e">#Share root CA file (riupie.com.crt) to each Kubernetes nodes. For example I do this on master nodes</span>
ubuntu@ag-k8s-master0:~$ sudo cp .cert/riupie.crt /etc/ssl/certs/riupie.com.pem
ubuntu@ag-k8s-master0:~$ sudo update-ca-certificates

</code></pre></div><h4 id="52-create-namespaces">5.2. Create namespaces</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ kubectl create namespace cert-manager
</code></pre></div><h4 id="53-add-helm-repo">5.3 Add helm repo</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ helm repo add jetstack https://charts.jetstack.io
ubuntu@ag-k8s-master0:~$ helm repo update
</code></pre></div><h4 id="54-install-cert-managercrd">5.4. Install cert-manager+CRD</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v1.0.1 --set installCRDs<span style="color:#f92672">=</span>true
</code></pre></div><h4 id="55-check-pods">5.5. Check pods</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ kubectl get pods --namespace cert-manager
</code></pre></div><h4 id="56-create-secret-for-ca-root">5.6 Create secret for CA Root</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ kubectl -n cert-manager create secret tls ssc-tls-secret --key<span style="color:#f92672">=</span>/home/ubuntu/.cert/riupie.com.key --cert<span style="color:#f92672">=</span>/home/ubuntu/.cert/riupie.com.crt
</code></pre></div><h4 id="57-create-issuer">5.7. Create Issuer</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ mkdir cert-manager
ubuntu@ag-k8s-master0:~$ cd cert-manager
ubuntu@ag-k8s-master0:~/cert-manager$ vim cluster-issuer.yml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#66d9ef">apiVersion</span>: cert-manager.io/v1alpha2
<span style="color:#66d9ef">kind</span>: ClusterIssuer
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: tls-ca-issuer
  <span style="color:#66d9ef">namespace</span>: cert-manager
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">ca</span>:
    <span style="color:#66d9ef">secretName</span>: ssc-tls-secret
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~/cert-manager$ kubectl create -f cluster-issuer.yml
</code></pre></div><h2 id="part-4-deploy-dex">Part 4: Deploy Dex</h2>
<h3 id="6-deploy-dex-deployment-and-resource">6. Deploy Dex Deployment and Resource</h3>
<h4 id="61-create-auth-system-namespace">6.1. Create auth-system namespace</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create ns auth-system
</code></pre></div><h4 id="62-create-yaml-file-for-dex-deployment">6.2. Create YAML File for Dex Deployment</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd
mkdir auth-system
cd auth-system

vim dex-system.yml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ServiceAccount
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: dex
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system
---
<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="color:#66d9ef">kind</span>: ClusterRole
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system
<span style="color:#66d9ef">rules</span>:
- <span style="color:#66d9ef">apiGroups</span>: [<span style="color:#e6db74">&#34;dex.coreos.com&#34;</span>]
  <span style="color:#66d9ef">resources</span>: [<span style="color:#e6db74">&#34;*&#34;</span>]
  <span style="color:#66d9ef">verbs</span>: [<span style="color:#e6db74">&#34;*&#34;</span>]
- <span style="color:#66d9ef">apiGroups</span>: [<span style="color:#e6db74">&#34;apiextensions.k8s.io&#34;</span>]
  <span style="color:#66d9ef">resources</span>: [<span style="color:#e6db74">&#34;customresourcedefinitions&#34;</span>]
  <span style="color:#66d9ef">verbs</span>: [<span style="color:#e6db74">&#34;create&#34;</span>]
---
<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="color:#66d9ef">kind</span>: ClusterRoleBinding
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system
<span style="color:#66d9ef">roleRef</span>:
  <span style="color:#66d9ef">apiGroup</span>: rbac.authorization.k8s.io
  <span style="color:#66d9ef">kind</span>: ClusterRole
  <span style="color:#66d9ef">name</span>: dex
<span style="color:#66d9ef">subjects</span>:
- <span style="color:#66d9ef">kind</span>: ServiceAccount
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system

---
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">config.yaml</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    issuer: https://dex.kubernetes.riupie.com</span>
    <span style="color:#66d9ef">web</span>:
      <span style="color:#66d9ef">http</span>: <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">5556</span>
    <span style="color:#66d9ef">frontend</span>:
      <span style="color:#66d9ef">theme</span>: custom
    <span style="color:#66d9ef">telemetry</span>:
      <span style="color:#66d9ef">http</span>: <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">5558</span>
    <span style="color:#66d9ef">staticClients</span>:
    - <span style="color:#66d9ef">id</span>: oidc-auth-client
      <span style="color:#66d9ef">redirectURIs</span>:
      - <span style="color:#e6db74">&#39;https://kubectl.kubernetes.riupie.com/callback&#39;</span>
      - <span style="color:#e6db74">&#39;http://dashboard.kubernetes.riupie.com/oauth2/callback&#39;</span>
      <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#39;oidc-auth-client&#39;</span>
      <span style="color:#66d9ef">secret</span>: XmT7EHo27skGchX0yLQNTYXibm3aNkx5
    <span style="color:#66d9ef">connectors</span>:
    - <span style="color:#66d9ef">type</span>: ldap
      <span style="color:#66d9ef">id</span>: ldap
      <span style="color:#66d9ef">name</span>: LDAP
      <span style="color:#66d9ef">config</span>:
        <span style="color:#66d9ef">host</span>: ldap.riupie.com:<span style="color:#ae81ff">389</span>
        <span style="color:#66d9ef">insecureNoSSL</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">insecureSkipVerify</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">bindDN</span>: CN=admin,DC=riupie,DC=com
        <span style="color:#66d9ef">bindPW</span>: mysecret <span style="color:#75715e">#Add Administrator password</span>
        <span style="color:#66d9ef">usernamePrompt</span>: SSO Username
        <span style="color:#66d9ef">userSearch</span>:
          <span style="color:#66d9ef">baseDN</span>: OU=People,DC=riupie,DC=com
          <span style="color:#66d9ef">filter</span>: <span style="color:#e6db74">&#34;(objectClass=person)&#34;</span>
          <span style="color:#66d9ef">username</span>: mail
          <span style="color:#66d9ef">idAttr</span>: uid
          <span style="color:#66d9ef">emailAttr</span>: mail
          <span style="color:#66d9ef">nameAttr</span>: cn
        <span style="color:#66d9ef">groupSearch</span>:
          <span style="color:#66d9ef">baseDN</span>: OU=Groups,DC=riupie,DC=com
          <span style="color:#66d9ef">filter</span>: <span style="color:#e6db74">&#34;(objectClass=groupOfNames)&#34;</span>
          <span style="color:#66d9ef">userAttr</span>: DN
          <span style="color:#66d9ef">groupAttr</span>: member
          <span style="color:#66d9ef">nameAttr</span>: cn
    <span style="color:#66d9ef">oauth2</span>:
      <span style="color:#66d9ef">skipApprovalScreen</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">storage</span>:
      <span style="color:#66d9ef">type</span>: kubernetes
      <span style="color:#66d9ef">config</span>:
        <span style="color:#66d9ef">inCluster</span>: <span style="color:#66d9ef">true</span>
---
<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: dex
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app</span>: dex
  <span style="color:#66d9ef">strategy</span>:
    <span style="color:#66d9ef">rollingUpdate</span>:
      <span style="color:#66d9ef">maxSurge</span>: <span style="color:#ae81ff">1</span>
      <span style="color:#66d9ef">maxUnavailable</span>: <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">type</span>: RollingUpdate
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app</span>: dex
        <span style="color:#66d9ef">revision</span>: <span style="color:#e6db74">&#34;1&#34;</span>
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">initContainers</span>:
      - <span style="color:#66d9ef">name</span>: dl-theme
        <span style="color:#66d9ef">image</span>: alpine/git
        <span style="color:#66d9ef">command</span>:
         - git
         - clone
         - <span style="color:#e6db74">&#34;https://github.com/sguyennet/dex-inkubate-branding.git&#34;</span>
         - /theme
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">name</span>: theme
          <span style="color:#66d9ef">mountPath</span>: /theme/
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">command</span>:
        - /usr/local/bin/dex
        - serve
        - /etc/dex/cfg/config.yaml
        <span style="color:#66d9ef">image</span>: quay.io/dexidp/dex:v2<span style="color:#ae81ff">.24.0</span>
        <span style="color:#66d9ef">imagePullPolicy</span>: IfNotPresent
        <span style="color:#66d9ef">name</span>: dex
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">5556</span>
          <span style="color:#66d9ef">name</span>: http
          <span style="color:#66d9ef">protocol</span>: TCP
        <span style="color:#66d9ef">resources</span>: {}
        <span style="color:#66d9ef">terminationMessagePath</span>: /dev/termination-log
        <span style="color:#66d9ef">terminationMessagePolicy</span>: File
        <span style="color:#66d9ef">volumeMounts</span>:
        - <span style="color:#66d9ef">mountPath</span>: /etc/dex/cfg
          <span style="color:#66d9ef">name</span>: config
        - <span style="color:#66d9ef">mountPath</span>: /web/themes/custom/
          <span style="color:#66d9ef">name</span>: theme
      <span style="color:#66d9ef">dnsPolicy</span>: ClusterFirst
      <span style="color:#66d9ef">serviceAccountName</span>: dex
      <span style="color:#66d9ef">restartPolicy</span>: Always
      <span style="color:#66d9ef">schedulerName</span>: default-scheduler
      <span style="color:#66d9ef">securityContext</span>: {}
      <span style="color:#66d9ef">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
      <span style="color:#66d9ef">volumes</span>:
      - <span style="color:#66d9ef">configMap</span>:
          <span style="color:#66d9ef">defaultMode</span>: <span style="color:#ae81ff">420</span>
          <span style="color:#66d9ef">items</span>:
          - <span style="color:#66d9ef">key</span>: config.yaml
            <span style="color:#66d9ef">path</span>: config.yaml
          <span style="color:#66d9ef">name</span>: dex
        <span style="color:#66d9ef">name</span>: config
      - <span style="color:#66d9ef">name</span>: theme
        <span style="color:#66d9ef">emptyDir</span>: {}
---
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: dex
  <span style="color:#66d9ef">namespace</span>: auth-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app</span>: dex
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">name</span>: dex
    <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">5556</span>
    <span style="color:#66d9ef">protocol</span>: TCP
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">5556</span>
---
<span style="color:#66d9ef">apiVersion</span>: networking.k8s.io/v1beta1
<span style="color:#66d9ef">kind</span>: Ingress
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: dex-ingress
  <span style="color:#66d9ef">namespace</span>: auth-system
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
    <span style="color:#66d9ef">cert-manager.io/cluster-issuer</span>: <span style="color:#e6db74">&#34;tls-ca-issuer&#34;</span>
<span style="color:#75715e">#    nginx.ingress.kubernetes.io/ssl-redirect: &#34;false&#34;</span>
    <span style="color:#66d9ef">ingress.kubernetes.io/force-ssl-redirect</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">tls</span>:
  - <span style="color:#66d9ef">hosts</span>:
    - dex.kubernetes.riupie.com
    <span style="color:#66d9ef">secretName</span>: dex
  <span style="color:#66d9ef">rules</span>:
  - <span style="color:#66d9ef">host</span>: dex.kubernetes.riupie.com
    <span style="color:#66d9ef">http</span>:
      <span style="color:#66d9ef">paths</span>:
      - <span style="color:#66d9ef">backend</span>:
          <span style="color:#66d9ef">serviceName</span>: dex
          <span style="color:#66d9ef">servicePort</span>: <span style="color:#ae81ff">5556</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f dex-system.yml
</code></pre></div><h4 id="63-verify-dex-deployment">6.3. Verify dex deployment.</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~/auth-system$ curl https://dex.kubernetes.riupie.com/.well-known/openid-configuration
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;issuer&#34;</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com&#34;</span>,
  <span style="color:#e6db74">&#34;authorization_endpoint&#34;</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com/auth&#34;</span>,
  <span style="color:#e6db74">&#34;token_endpoint&#34;</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com/token&#34;</span>,
  <span style="color:#e6db74">&#34;jwks_uri&#34;</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com/keys&#34;</span>,
  <span style="color:#e6db74">&#34;userinfo_endpoint&#34;</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com/userinfo&#34;</span>,
  <span style="color:#e6db74">&#34;response_types_supported&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;code&#34;</span>
  <span style="color:#f92672">]</span>,
  <span style="color:#e6db74">&#34;subject_types_supported&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;public&#34;</span>
  <span style="color:#f92672">]</span>,
  <span style="color:#e6db74">&#34;id_token_signing_alg_values_supported&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;RS256&#34;</span>
  <span style="color:#f92672">]</span>,
  <span style="color:#e6db74">&#34;scopes_supported&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;openid&#34;</span>,
    <span style="color:#e6db74">&#34;email&#34;</span>,
    <span style="color:#e6db74">&#34;groups&#34;</span>,
    <span style="color:#e6db74">&#34;profile&#34;</span>,
    <span style="color:#e6db74">&#34;offline_access&#34;</span>
  <span style="color:#f92672">]</span>,
  <span style="color:#e6db74">&#34;token_endpoint_auth_methods_supported&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;client_secret_basic&#34;</span>
  <span style="color:#f92672">]</span>,
  <span style="color:#e6db74">&#34;claims_supported&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;aud&#34;</span>,
    <span style="color:#e6db74">&#34;email&#34;</span>,
    <span style="color:#e6db74">&#34;email_verified&#34;</span>,
    <span style="color:#e6db74">&#34;exp&#34;</span>,
    <span style="color:#e6db74">&#34;iat&#34;</span>,
    <span style="color:#e6db74">&#34;iss&#34;</span>,
    <span style="color:#e6db74">&#34;locale&#34;</span>,
    <span style="color:#e6db74">&#34;name&#34;</span>,
    <span style="color:#e6db74">&#34;sub&#34;</span>
  <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="64-configure-kubernetes-api">6.4. Configure Kubernetes API</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/kubernetes/manifests/kube-apiserver.yaml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">...
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">containers</span>:
  - <span style="color:#66d9ef">command</span>:
    - kube-apiserver
    ....
    - --oidc-issuer-url=https://dex.kubernetes.riupie.com
    - --oidc-client-id=oidc-auth-client
    - --oidc-username-claim=email
    - --oidc-groups-claim=groups
...
</code></pre></div><h4 id="65-wait-for-kube-api-pods-to-restart">6.5. Wait for kube-api pods to restart</h4>
<h3 id="7-deploy-gangway">7. Deploy Gangway</h3>
<h4 id="71-create-secret-key-for-gangway">7.1. Create secret key for Gangway</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n auth-system create secret generic gangway-key --from-literal<span style="color:#f92672">=</span>sesssionkey<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>openssl rand -base64 32<span style="color:#66d9ef">)</span>
</code></pre></div><h4 id="72-create-gangway-yaml-deployment">7.2. Create Gangway YAML deployment</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd
cd auth-system

vim gangway-system.yml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: gangway
  <span style="color:#66d9ef">namespace</span>: auth-system
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">gangway.yaml</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    clusterName: &#34;kubernetes&#34;</span>
    <span style="color:#66d9ef">apiServerURL</span>: <span style="color:#e6db74">&#34;https://10.54.54.10:6443&#34;</span>
    <span style="color:#66d9ef">authorizeURL</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com/auth&#34;</span>
    <span style="color:#66d9ef">tokenURL</span>: <span style="color:#e6db74">&#34;https://dex.kubernetes.riupie.com/token&#34;</span>
    <span style="color:#66d9ef">clientID</span>: <span style="color:#e6db74">&#34;oidc-auth-client&#34;</span>
    <span style="color:#66d9ef">clientSecret</span>: <span style="color:#e6db74">&#34;XmT7EHo27skGchX0yLQNTYXibm3aNkx5&#34;</span>
    <span style="color:#66d9ef">redirectURL</span>: <span style="color:#e6db74">&#34;https://kubectl.kubernetes.riupie.com/callback&#34;</span>
    <span style="color:#66d9ef">scopes</span>: [<span style="color:#e6db74">&#34;openid&#34;</span>, <span style="color:#e6db74">&#34;profile&#34;</span>, <span style="color:#e6db74">&#34;email&#34;</span>,<span style="color:#e6db74">&#34;groups&#34;</span>, <span style="color:#e6db74">&#34;offline_access&#34;</span>]
    <span style="color:#66d9ef">usernameClaim</span>: <span style="color:#e6db74">&#34;email&#34;</span>
    <span style="color:#66d9ef">emailClaim</span>: <span style="color:#e6db74">&#34;email&#34;</span>
    <span style="color:#66d9ef">trustedCAPath</span>: <span style="color:#e6db74">&#34;/cacerts/tls.crt&#34;</span>
---
<span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: gangway
  <span style="color:#66d9ef">namespace</span>: auth-system
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: gangway
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app</span>: gangway
  <span style="color:#66d9ef">strategy</span>:
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app</span>: gangway
        <span style="color:#66d9ef">revision</span>: <span style="color:#e6db74">&#34;1&#34;</span>
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
        - <span style="color:#66d9ef">name</span>: gangway
          <span style="color:#66d9ef">image</span>: gcr.io/heptio-images/gangway:v3<span style="color:#ae81ff">.2.0</span>
          <span style="color:#66d9ef">imagePullPolicy</span>: Always
          <span style="color:#66d9ef">command</span>: [<span style="color:#e6db74">&#34;gangway&#34;</span>, <span style="color:#e6db74">&#34;-config&#34;</span>, <span style="color:#e6db74">&#34;/gangway/gangway.yaml&#34;</span>]
          <span style="color:#66d9ef">env</span>:
            - <span style="color:#66d9ef">name</span>: GANGWAY_SESSION_SECURITY_KEY
              <span style="color:#66d9ef">valueFrom</span>:
                <span style="color:#66d9ef">secretKeyRef</span>:
                  <span style="color:#66d9ef">name</span>: gangway-key
                  <span style="color:#66d9ef">key</span>: sesssionkey
          <span style="color:#66d9ef">ports</span>:
            - <span style="color:#66d9ef">name</span>: http
              <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">8080</span>
              <span style="color:#66d9ef">protocol</span>: TCP
          <span style="color:#66d9ef">resources</span>:
            <span style="color:#66d9ef">requests</span>:
              <span style="color:#66d9ef">cpu</span>: <span style="color:#e6db74">&#34;100m&#34;</span>
              <span style="color:#66d9ef">memory</span>: <span style="color:#e6db74">&#34;100Mi&#34;</span>
            <span style="color:#66d9ef">limits</span>:
              <span style="color:#66d9ef">cpu</span>: <span style="color:#e6db74">&#34;100m&#34;</span>
              <span style="color:#66d9ef">memory</span>: <span style="color:#e6db74">&#34;100Mi&#34;</span>
          <span style="color:#66d9ef">volumeMounts</span>:
            - <span style="color:#66d9ef">name</span>: gangway
              <span style="color:#66d9ef">mountPath</span>: /gangway/
            - <span style="color:#66d9ef">name</span>: ca
              <span style="color:#66d9ef">mountPath</span>: /cacerts/
          <span style="color:#66d9ef">livenessProbe</span>:
            <span style="color:#66d9ef">httpGet</span>:
              <span style="color:#66d9ef">path</span>: /
              <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
            <span style="color:#66d9ef">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">60</span>
            <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">3</span>
          <span style="color:#66d9ef">readinessProbe</span>:
            <span style="color:#66d9ef">httpGet</span>:
              <span style="color:#66d9ef">path</span>: /
              <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#66d9ef">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">10</span>
            <span style="color:#66d9ef">failureThreshold</span>: <span style="color:#ae81ff">3</span>
      <span style="color:#66d9ef">volumes</span>:
        - <span style="color:#66d9ef">name</span>: gangway
          <span style="color:#66d9ef">configMap</span>:
            <span style="color:#66d9ef">name</span>: gangway
        - <span style="color:#66d9ef">name</span>: ca
          <span style="color:#66d9ef">secret</span>:
            <span style="color:#66d9ef">secretName</span>: dex
---
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: gangway-svc
  <span style="color:#66d9ef">namespace</span>: auth-system
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: gangway
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">type</span>: ClusterIP
  <span style="color:#66d9ef">ports</span>:
    - <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;http&#34;</span>
      <span style="color:#66d9ef">protocol</span>: TCP
      <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">80</span>
      <span style="color:#66d9ef">targetPort</span>: <span style="color:#e6db74">&#34;http&#34;</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app</span>: gangway
---
<span style="color:#66d9ef">apiVersion</span>: networking.k8s.io/v1beta1
<span style="color:#66d9ef">kind</span>: Ingress
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: gangway
  <span style="color:#66d9ef">namespace</span>: auth-system
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
    <span style="color:#66d9ef">cert-manager.io/cluster-issuer</span>: <span style="color:#e6db74">&#34;tls-ca-issuer&#34;</span>
<span style="color:#75715e">#    nginx.ingress.kubernetes.io/ssl-redirect: &#34;true&#34;</span>
    <span style="color:#66d9ef">nginx.ingress.kubernetes.io/force-ssl-redirect</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">tls</span>:
  - <span style="color:#66d9ef">hosts</span>:
    - kubectl.kubernetes.riupie.com
    <span style="color:#66d9ef">secretName</span>: gangway
  <span style="color:#66d9ef">rules</span>:
  - <span style="color:#66d9ef">host</span>: kubectl.kubernetes.riupie.com
    <span style="color:#66d9ef">http</span>:
      <span style="color:#66d9ef">paths</span>:
      - <span style="color:#66d9ef">backend</span>:
          <span style="color:#66d9ef">serviceName</span>: gangway-svc
          <span style="color:#66d9ef">servicePort</span>: http
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f gangway-system.yml
</code></pre></div><h4 id="74-verify-dex-and-gangway-pods">7.4. Verify dex and gangway pods</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubuntu@ag-k8s-master0:~$ kubectl get pods -n auth-system
NAME                            READY   STATUS    RESTARTS   AGE
dex-74fb858546-5jccf            1/1     Running   <span style="color:#ae81ff">0</span>          5d15h
gangway-64b4788d5c-7tdcr        1/1     Running   <span style="color:#ae81ff">0</span>          5d15h
</code></pre></div><h4 id="75-create-rbac-for-admins-group">7.5 Create RBAC for admins Group</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim rbac-admin.yml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="color:#66d9ef">kind</span>: ClusterRoleBinding
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: admin-user
<span style="color:#66d9ef">roleRef</span>:
  <span style="color:#66d9ef">apiGroup</span>: rbac.authorization.k8s.io
  <span style="color:#66d9ef">kind</span>: ClusterRole
  <span style="color:#66d9ef">name</span>: cluster-admin
<span style="color:#66d9ef">subjects</span>:
- <span style="color:#66d9ef">kind</span>: Group
  <span style="color:#66d9ef">name</span>: admins
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f rbac-admins.yml
</code></pre></div><h4 id="76-create-rbac-for-developers-group">7.6. Create RBAC for developers Group</h4>
<p>LDAP users in group developers only have read access.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim rbac-dev.yml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="color:#66d9ef">kind</span>: ClusterRoleBinding
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: dev-user
<span style="color:#66d9ef">roleRef</span>:
  <span style="color:#66d9ef">apiGroup</span>: rbac.authorization.k8s.io
  <span style="color:#66d9ef">kind</span>: ClusterRole
  <span style="color:#66d9ef">name</span>: view
<span style="color:#66d9ef">subjects</span>:
- <span style="color:#66d9ef">kind</span>: Group
  <span style="color:#66d9ef">name</span>: developers
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f rbac-dev.yml
</code></pre></div><h4 id="77-accesing-gangway">7.7. Accesing Gangway</h4>
<p>Access to <a href="https://kubectl.kubernetes.riupie.com">https://kubectl.kubernetes.riupie.com</a> then login using johndoe user.
<img src="imgs/gangway-1.png" alt="gangway-1">
<img src="imgs/gangway-2.png" alt="gangway-2">
<img src="imgs/gangway-3.png" alt="gangway-3"></p>

  </div>
</div>
<div class="d-flex flex-row justify-content-center">
  <h3 class="mb-1 mt-1 text-left mr-4">
    
    <a
      href="/blog/deploying-openstack-hci/"
      title="Deploying HCI Openstack using Kolla Ansible"
    >
      <i class="nav-menu fas fa-chevron-circle-left"></i>
    </a>
    
  </h3>
  <h3 class="mb-1 mt-1 text-left ml-4">
    
    <i class="nav-menu-disabled fas fa-chevron-circle-right"></i>
    
  </h3>
</div>


    </main>
    
    <footer class=" mt-2 mb-4 text-center ">
  <span class="markdownify">2020</span>
  <span >
    &middot;
    <i>
      <a href="https://rahmatawe.com">
        Rahmat Agung W
      </a>
    </i>
  </span>
</footer>

    
  </body>
</html>
