<!doctype html><html lang=en><head><title>Send Log from Event Viewer on Windows Server 2019 to Grafana Loki</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.9d3302cae19940ba14d96763a5e460919c05c0d775b27fbfd5c0448566723c84.css integrity="sha256-nTMCyuGZQLoU2WdjpeRgkZwFwNd1sn+/1cBEhWZyPIQ="><link rel=icon type=image/png href=/images/site/favicon_hua3f1c5b7c02379fe7fe265bd92e39364_213598_42x0_resize_box_3.png><meta property="og:title" content="Send Log from Event Viewer on Windows Server 2019 to Grafana Loki"><meta property="og:description" content="Send Log from Event Viewer on Windows Server 2019 to Grafana Loki"><meta property="og:type" content="article"><meta property="og:url" content="https://www.rahmatawe.com/posts/send-event-viewer-log-to-grafana-loki/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-15T08:06:25+06:00"><meta property="article:modified_time" content="2022-04-15T08:06:25+06:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Send Log from Event Viewer on Windows Server 2019 to Grafana Loki"><meta name=twitter:description content="Send Log from Event Viewer on Windows Server 2019 to Grafana Loki"><meta name=description content="Send Log from Event Viewer on Windows Server 2019 to Grafana Loki"><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hua3f1c5b7c02379fe7fe265bd92e39364_213598_42x0_resize_box_3.png id=logo alt=Logo>
RahmatAwe</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-toggle=collapse data-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#experiences>Experiences</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link id=note-link href=/notes>Notes</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hua3f1c5b7c02379fe7fe265bd92e39364_213598_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hua3f1c5b7c02379fe7fe265bd92e39364_213598_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a class="active list-link" href=/posts/send-event-viewer-log-to-grafana-loki/ title="Send Log from Event Viewer on Windows Server 2019 to Grafana Loki">Send Log from Event Viewer on Windows Server 2019 to Grafana Loki</a></li><li><a class=list-link href=/posts/tidy-up-prometheus/ title="Tidy up our Prometheus metrics!">Tidy up our Prometheus metrics!</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/posts/send-event-viewer-log-to-grafana-loki/imgs/title.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu16448ac429c38ba18c482778881986b4_77719_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>Rahmat Agung Wibowo</h5><p class=text-muted>Friday, April 15, 2022 | 4 minutes</p></div><div class=title><h1>Send Log from Event Viewer on Windows Server 2019 to Grafana Loki</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/linux/ class="btn, btn-sm">linux</a></li><li class=rounded><a href=/tags/monitoring/ class="btn, btn-sm">monitoring</a></li></ul></div><div class=post-content id=post-content><p>It&rsquo;s just PoC of collecting Windows logs using open source project such as Promtail, Loki and Grafana.</p><h3 id=environment>Environment</h3><div style=text-align:right><img src=imgs/infra-diagram.png></div><pre tabindex=0><code># Servers
ag-rh2 : 10.54.54.6 (Grafana + Loki)
win2k19 : 10.54.54.219 (Promtail)

# OS Packages Release
RHEL 8.4
Windows Server 2019
Loki 2.5
Grafana 8.4.6
</code></pre><h3 id=setup-loki>Setup Loki</h3><h4 id=1-download-package-loki>1. Download package Loki</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -O -L <span style=color:#e6db74>&#34;https://github.com/grafana/loki/releases/download/v2.5.0/loki-linux-amd64.zip&#34;</span>
</span></span></code></pre></div><h4 id=2-setup-loki-binary>2. Setup loki binary</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Unzip package</span>
</span></span><span style=display:flex><span>unzip loki-linux-amd64.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Grant execute permission</span>
</span></span><span style=display:flex><span>chmod +x loki-linux-amd64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create directory for loki installation</span>
</span></span><span style=display:flex><span>sudo mkdir -p /opt/loki/<span style=color:#f92672>{</span>bin,conf,data<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Move loki binary</span>
</span></span><span style=display:flex><span>mv loki-linux-amd64 /opt/loki/bin/loki
</span></span></code></pre></div><h4 id=3-setup-loki-configuration>3. Setup loki configuration</h4><p>Default configuration can be retrieved from <a href=https://raw.githubusercontent.com/grafana/loki/master/cmd/loki/loki-local-config.yaml target=_blank rel=noopener>here</a>. I create loki config on <code>/opt/loki/config/loki-local-config.yaml</code> using below content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>auth_enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>3100</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>ingester</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>lifecycler</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ring</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>kvstore</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>store</span>: <span style=color:#ae81ff>inmemory</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>replication_factor</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>final_sleep</span>: <span style=color:#ae81ff>0s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>chunk_idle_period</span>: <span style=color:#ae81ff>1h      </span> <span style=color:#75715e># Any chunk not receiving new logs in this time will be flushed</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>max_chunk_age</span>: <span style=color:#ae81ff>1h          </span> <span style=color:#75715e># All chunks will be flushed when they hit this age, default is 1h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>chunk_target_size</span>: <span style=color:#ae81ff>1048576</span>  <span style=color:#75715e># Loki will attempt to build chunks up to 1.5MB, flushing first if chunk_idle_period or max_chunk_age is reached first</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>chunk_retain_period</span>: <span style=color:#ae81ff>30s   </span> <span style=color:#75715e># Must be greater than index read cache TTL if using an index cache (Default index read cache TTL is 5m)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>max_transfer_retries</span>: <span style=color:#ae81ff>0</span>     <span style=color:#75715e># Chunk transfers disabled</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>wal</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dir</span>: <span style=color:#ae81ff>/opt/loki/data/wal</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>schema_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>from</span>: <span style=color:#e6db74>2020-10-24</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>store</span>: <span style=color:#ae81ff>boltdb-shipper</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>object_store</span>: <span style=color:#ae81ff>filesystem</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>schema</span>: <span style=color:#ae81ff>v11</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>index</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>index_</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>period</span>: <span style=color:#ae81ff>24h</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>storage_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>boltdb_shipper</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>active_index_directory</span>: <span style=color:#ae81ff>/opt/loki/data/boltdb-shipper-active</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache_location</span>: <span style=color:#ae81ff>/opt/loki/data/boltdb-shipper-cache</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache_ttl</span>: <span style=color:#ae81ff>24h        </span> <span style=color:#75715e># Can be increased for faster performance over longer query periods, uses more disk space</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>shared_store</span>: <span style=color:#ae81ff>filesystem</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>filesystem</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>directory</span>: <span style=color:#ae81ff>/opt/loki/data/chunks</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>compactor</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>working_directory</span>: <span style=color:#ae81ff>/opt/loki/data/boltdb-shipper-compactor</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>shared_store</span>: <span style=color:#ae81ff>filesystem</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>compaction_interval</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_delete_delay</span>: <span style=color:#ae81ff>2h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_delete_worker_count</span>: <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>limits_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>reject_old_samples</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>reject_old_samples_max_age</span>: <span style=color:#ae81ff>168h</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>chunk_store_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>max_look_back_period</span>: <span style=color:#ae81ff>0s</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>table_manager</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_deletes_enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_period</span>: <span style=color:#ae81ff>30d</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>ruler</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>local</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>directory</span>: <span style=color:#ae81ff>/opt/loki/data/rules</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rule_path</span>: <span style=color:#ae81ff>/opt/loki/data/rules-temp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>alertmanager_url</span>: <span style=color:#ae81ff>http://localhost:9093</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ring</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kvstore</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>store</span>: <span style=color:#ae81ff>inmemory</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enable_api</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>analytics</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>reporting_enabled</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>On above configuration, there is configuration for alertmanager but we will not include alertmanager installation in this post.</p><h4 id=4-create-system-user-for-loki>4. Create system user for loki</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo useradd --system loki
</span></span></code></pre></div><h4 id=5-change-permission-on-loki-directory>5. Change permission on loki directory</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Change ownership</span>
</span></span><span style=display:flex><span>sudo chown -R loki:loki /opt/loki
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Restore SELinux label</span>
</span></span><span style=display:flex><span>sudo restorecon -vRF /opt/loki/
</span></span></code></pre></div><h4 id=6-run-loki-service-on-systemd>6. Run loki service on systemd</h4><p>First, create systemd file for loki on <code>/etc/systemd/system/loki.service</code>. Paste below content.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Loki service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>simple</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>loki</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/opt/loki/bin/loki -config.file /opt/loki/conf/loki-local-config.yaml</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>Then, run loki service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable --now loki.service
</span></span></code></pre></div><h4 id=7-open-port-for-loki-service>7. Open port for loki service</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo firewall-cmd --add-port 3100/tcp --permanent
</span></span><span style=display:flex><span>sudo firewall-cmd --reload
</span></span></code></pre></div><h3 id=setup-grafana>Setup Grafana</h3><h4 id=1-download-grafana-rpm-package>1. Download Grafana RPM package</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -O -L https://dl.grafana.com/oss/release/grafana-8.4.6-1.x86_64.rpm
</span></span></code></pre></div><h4 id=2-install-package>2. Install package</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum localinstall grafana-8.4.6-1.x86_64.rpm
</span></span></code></pre></div><h4 id=3-start-grafana-service>3. Start grafana service</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable --now grafana-server.service
</span></span></code></pre></div><h4 id=4-open-port-for-grafana-service>4. Open port for grafana service</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo firewall-cmd --add-port 3000/tcp --permanent
</span></span><span style=display:flex><span>sudo firewall-cmd --reload
</span></span></code></pre></div><h4 id=5-add-loki-datasource-to-grafana>5. Add Loki datasource to Grafana.</h4><p>Open grafana URL on 10.54.54.6:3000 then add Loki as datasource.
<img src=imgs/loki-ds.png alt="lok datasource"></p><h3 id=setup-promtail>Setup Promtail</h3><h4 id=1-download-promtail-binary>1. Download promtail binary</h4><p>To collect log from vent Viewer on Windows Server, we need to setup promtail. Binary file can be downloaded in <a href=https://github.com/grafana/loki/releases/download/v2.5.0/promtail-windows-amd64.exe.zip target=_blank rel=noopener>here</a>. Move the exctracted file to <code>C:\Program Files\promtail</code>, see below for detail.
<img src=imgs/promtail-dir.png alt="Promtail Directory">
For new installation, it should be contain only the binary file <code>promtail-windows-amd64.exe</code>.</p><h4 id=2-create-promtail-configuration>2. Create promtail configuration</h4><p>Create promtail configuration file <code>promtail-local-config.yaml</code> with following content.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>grpc_listen_port</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>clients</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://10.54.54.6:3100/loki/api/v1/push</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>windows-application</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>windows_events</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>eventlog_name</span>: <span style=color:#e6db74>&#34;Application&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>xpath_query</span>: <span style=color:#e6db74>&#34;*[System[(Level=1 or Level=2 or Level=3)]]&#34;</span> <span style=color:#75715e># Critical, Error, Warning</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>logsource</span>: <span style=color:#ae81ff>windows-eventlog</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>use_incoming_timestamp</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bookmark_path</span>: <span style=color:#e6db74>&#34;./bookmark-application.xml&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exclude_event_data</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipeline_stages</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>json</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>expressions</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>level</span>: <span style=color:#ae81ff>levelText</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>        <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;computer&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#39;host&#39;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>windows-security</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>windows_events</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>eventlog_name</span>: <span style=color:#e6db74>&#34;Security&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>xpath_query</span>: <span style=color:#e6db74>&#34;*[System[(Level=1 or Level=2 or Level=3)]]&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>logsource</span>: <span style=color:#ae81ff>windows-eventlog</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>use_incoming_timestamp</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bookmark_path</span>: <span style=color:#e6db74>&#34;./bookmark-security.xml&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exclude_event_data</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exclude_user_data</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipeline_stages</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>json</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>expressions</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>level</span>: <span style=color:#ae81ff>levelText</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>        <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;computer&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#39;host&#39;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>windows-system</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>windows_events</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>eventlog_name</span>: <span style=color:#e6db74>&#34;System&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>xpath_query</span>: <span style=color:#e6db74>&#34;*[System[(Level=1 or Level=2 or Level=3)]]&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>logsource</span>: <span style=color:#ae81ff>windows-eventlog</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>use_incoming_timestamp</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bookmark_path</span>: <span style=color:#e6db74>&#34;./bookmark-system.xml&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exclude_event_data</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exclude_user_data</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipeline_stages</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>json</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>expressions</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>level</span>: <span style=color:#ae81ff>levelText</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>        <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;computer&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#39;host&#39;</span>
</span></span></code></pre></div><h4 id=3-test-promtail>3. Test promtail</h4><p>Test the configuration by running promtail directly via Powershell. Use Ctrl+C to stop program.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&amp; <span style=color:#e6db74>&#39;C:\Program Files\promtail\promtail-windows-amd64.exe&#39;</span> --config.file<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;C:\Program Files\promtail\promtail-local-config.yaml&#39;</span>
</span></span></code></pre></div><h4 id=4-run-promtail-using-windows-service-wrapper>4. Run promtail using windows service wrapper.</h4><p>There are some service wrapper on Windows, for example: sc.exe, nssm.exe and winsw. Windows has built in service wrapper: sc.exe, but when I use <code>sc.exe</code> to run promtail it always return error: <code>StartService FAILED 1053</code>. I&rsquo;m not really familiar with Windows Server, so still figuring out why this error appear. So, I use <a href=https://nssm.cc/download target=_blank rel=noopener>nssm</a> to wrap my promtail. You only need to download, unzip it and run below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.<span style=color:#ae81ff>\n</span>ssm.exe install promtail
</span></span></code></pre></div><p>Boom, GUI windows will appear. Set the setting like below.
<img src=imgs/nssm-config.png alt="nssm GUI">
You can also bypass the GUI, with <code>.\nssm install &lt;servicename> &lt;application> [&lt;options>]</code>.</p><p>After service created, configure log file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.<span style=color:#ae81ff>\n</span>ssm.exe set promtail AppStderr <span style=color:#e6db74>&#39;C:\Program Files\promtail\promtail-error.log&#39;</span>
</span></span><span style=display:flex><span>.<span style=color:#ae81ff>\n</span>ssm.exe set promtail AppStdout <span style=color:#e6db74>&#39;C:\Program Files\promtail\promtail.log&#39;</span>
</span></span></code></pre></div><p>Then, start the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.<span style=color:#ae81ff>\n</span>ssm.exe start promtail
</span></span></code></pre></div><h4 id=5-open-grafana-to-check-incoming-logs>5. Open Grafana to check incoming logs</h4><p><img src=imgs/loki-query.png alt="grafana loki logs"></p><p>References:</p><p><a href=https://grafana.com/docs/loki/latest/operations/storage/retention/ target=_blank rel=noopener>Grafana Loki Storage Retention</a></p><p><a href=https://reachmnadeem.wordpress.com/2020/12/30/log-scrapping-made-easy-with-grafana-loki-in-windows/ target=_blank rel=noopener>Log Scrapping made Easy with Grafana Loki in Windows</a></p><p><a href=https://grafana.com/docs/loki/latest/clients/promtail/scraping/#windows-event-log target=_blank rel=noopener>Promtail Scraping (Service Discovery)</a></p><p><a href=https://grafana.com/docs/loki/latest/clients/promtail/stages/ target=_blank rel=noopener>Stages</a></p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.rahmatawe.com%2fposts%2fsend-event-viewer-log-to-grafana-loki%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.rahmatawe.com%2fposts%2fsend-event-viewer-log-to-grafana-loki%2f&text=Send%20Log%20from%20Event%20Viewer%20on%20Windows%20Server%202019%20to%20Grafana%20Loki&via=RahmatAwe" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.rahmatawe.com%2fposts%2fsend-event-viewer-log-to-grafana-loki%2f&title=Send%20Log%20from%20Event%20Viewer%20on%20Windows%20Server%202019%20to%20Grafana%20Loki" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.rahmatawe.com%2fposts%2fsend-event-viewer-log-to-grafana-loki%2f&title=Send%20Log%20from%20Event%20Viewer%20on%20Windows%20Server%202019%20to%20Grafana%20Loki" target=_blank><i class="fab fa-linkedin"></i></a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-12 next-article"><a href=/posts/tidy-up-prometheus/ title="Tidy up our Prometheus metrics!" class="btn filled-button"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Tidy up our Prometheus metrics!</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn data-toggle=tooltip data-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#environment>Environment</a></li><li><a href=#setup-loki>Setup Loki</a><ul><li><a href=#1-download-package-loki>1. Download package Loki</a></li><li><a href=#2-setup-loki-binary>2. Setup loki binary</a></li><li><a href=#3-setup-loki-configuration>3. Setup loki configuration</a></li><li><a href=#4-create-system-user-for-loki>4. Create system user for loki</a></li><li><a href=#5-change-permission-on-loki-directory>5. Change permission on loki directory</a></li><li><a href=#6-run-loki-service-on-systemd>6. Run loki service on systemd</a></li><li><a href=#7-open-port-for-loki-service>7. Open port for loki service</a></li></ul></li><li><a href=#setup-grafana>Setup Grafana</a><ul><li><a href=#1-download-grafana-rpm-package>1. Download Grafana RPM package</a></li><li><a href=#2-install-package>2. Install package</a></li><li><a href=#3-start-grafana-service>3. Start grafana service</a></li><li><a href=#4-open-port-for-grafana-service>4. Open port for grafana service</a></li><li><a href=#5-add-loki-datasource-to-grafana>5. Add Loki datasource to Grafana.</a></li></ul></li><li><a href=#setup-promtail>Setup Promtail</a><ul><li><a href=#1-download-promtail-binary>1. Download promtail binary</a></li><li><a href=#2-create-promtail-configuration>2. Create promtail configuration</a></li><li><a href=#3-test-promtail>3. Test promtail</a></li><li><a href=#4-run-promtail-using-windows-service-wrapper>4. Run promtail using windows service wrapper.</a></li><li><a href=#5-open-grafana-to-check-incoming-logs>5. Open Grafana to check incoming logs</a></li></ul></li></ul></li></ul></nav></div></div></section></div><script src=/application.4785df1e2116a10eb5fd00831c92608aa230f4fe81f7ccb9009aca0d7ec197a6.js integrity="sha256-R4XfHiEWoQ61/QCDHJJgiqIw9P6B98y5AJrKDX7Bl6Y=" defer></script></body></html>